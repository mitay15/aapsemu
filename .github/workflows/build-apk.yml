name: Build Kivy APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build APK with python-for-android Docker
      run: |
        docker run --rm -v $GITHUB_WORKSPACE:/home/user/hostcwd kivy/python-for-android:latest \
          /usr/bin/python3 -m pythonforandroid.toolchain apk \
          --bootstrap sdl2 \
          --requirements python3,kivy==2.3.0,pandas,openpyxl,pyjnius,pillow \
          --arch arm64-v8a \
          --arch armeabi-v7a \
          --private /home/user/hostcwd \
          --name "AAPS Emulator" \
          --package org.dima.aapsemulator \
          --version 0.1 \
          --entrypoint main.py \
          --log-level 2

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*.apk
